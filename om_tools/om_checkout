#!/bin/sh
#
# $Id: om_checkout 74 2007-04-15 14:11:35Z phantom $
#
# om_checkout - Checkout and Restore Owners and Modes of files.
#
# It checks out what do you want and run script generated by 'om_collect'
# for restoring owners and modes of files in working copy. By default
# this script is 'om_restore', but you can specify another file name by
# third parameter.
#
# Usage:
#   om_checkout /path/to/repos /path/to/wc [script-name]
#
# Algorithm:
#   - check out from /path/to/repos into temporary directory
#   - restore owners and modes of files by 'om_restore' script that placed
#     in already created working copy
#   - copy all from working copy to /path/to/wc. It can overwrite existing
#     files, but you will get real working copy by overlaying it
#   - remove temporary directory.
#
# After you continue working with /path/to/wc.
#


. om_common


# check params
#-------------
if [ $# -lt 2 ]; then
	echo "Usage:"
	echo "  om_checkout /path/to/repos /path/to/wc [script-name]"
	exit 1
fi


# get script file name
#---------------------
if [ $# -ge 3 ]; then
	script_file=$3
else
	script_file=$OM_DEF_SCRIPT_NAME
fi


# check repository path
#----------------------
if ! svn info $1 > /dev/null; then
	exit 2
fi


# generate name of temporary directory
#-------------------------------------
random_string="/tmp/om_checkout_wc_"
chars_count=20
gen_random_string
wc_tmp=$random_string


# check out to temporary directory
#---------------------------------
svn co $1 $wc_tmp


# restore files' flags
#---------------------
if [ -f $wc_tmp/$script_file ]; then
	$wc_tmp/$script_file $wc_tmp
fi


# copy it to defined working copy
#--------------------------------
cp -Rfp $wc_tmp/ $2


# remove temporary directory
#---------------------------
rm -Rf $wc_tmp


exit 0

